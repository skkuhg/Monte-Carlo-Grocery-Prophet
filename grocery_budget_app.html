<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery Budget Risk Analysis via Monte Carlo Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .app-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .app-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .app-header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .app-header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.95;
        }
        .section {
            padding: 20px;
            margin: 20px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .control-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        .input-field {
            width: 100px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            margin: 10px 5px;
        }
        .button:hover {
            background: #5a67d8;
        }
        .button.secondary {
            background: #6c757d;
        }
        .button.secondary:hover {
            background: #545b62;
        }
        .results-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        .data-table tr:hover {
            background: #f5f5f5;
        }
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            background: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 20px;
            background: #667eea;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9em;
        }
        .sensitivity-heatmap {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 15px 0;
        }
        .heatmap-cell {
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .category-input {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .category-input input {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <h1>üõí Grocery Budget Risk Analysis</h1>
            <p>Interactive Monte Carlo Simulation for Smart Budget Planning</p>
        </div>

        <!-- Executive Summary -->
        <div class="section">
            <h2>üìä Executive Summary</h2>
            <p>This interactive application uses Monte Carlo simulation to quantify the probability of exceeding your monthly grocery budget. By modeling price volatility and consumption patterns across different grocery categories, we provide data-driven insights to optimize your budget allocation and shopping strategy.</p>
        </div>

        <!-- Configuration Panel -->
        <div class="section">
            <h2>‚öôÔ∏è Configuration</h2>
            <div class="control-panel">
                <div class="control-group">
                    <label for="budget">Monthly Budget ($):</label>
                    <input type="number" id="budget" class="input-field" value="600" min="100" max="2000">
                </div>
                
                <div class="control-group">
                    <label for="iterations">Monte Carlo Iterations:</label>
                    <input type="range" id="iterations" class="slider" min="1000" max="10000" value="5000" step="500">
                    <span id="iterations-display">5000</span>
                </div>

                <div class="control-group">
                    <label>Historical Data Period:</label>
                    <select id="data-period" class="input-field">
                        <option value="3">3 months</option>
                        <option value="6" selected>6 months</option>
                        <option value="12">12 months</option>
                    </select>
                </div>
            </div>

            <!-- Category Configuration -->
            <h3>üì¶ Grocery Categories</h3>
            <div class="categories-grid" id="categories-grid">
                <!-- Categories will be populated by JavaScript -->
            </div>

            <button class="button" onclick="runSimulation()">üé≤ Run Monte Carlo Simulation</button>
            <button class="button secondary" onclick="generateSampleData()">üìÅ Generate Sample Data</button>
        </div>

        <!-- Progress Section -->
        <div class="section" id="progress-section" style="display: none;">
            <div class="loading">
                <div class="spinner"></div>
                <p id="progress-text">Initializing simulation...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="section" id="results-section" style="display: none;">
            <h2>üìä Risk Analysis Results</h2>
            <div class="results-box">
                <h3>Your Grocery Budget Risk Profile:</h3>
                <div class="results-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="overspend-prob">--.--%</div>
                        <div class="metric-label">Overspend Probability</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="expected-spend">$ ---.--</div>
                        <div class="metric-label">Expected Monthly Spend</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="var-95">$ ---.--</div>
                        <div class="metric-label">95% VaR</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="budget-buffer">$ --.--</div>
                        <div class="metric-label">Recommended Buffer</div>
                    </div>
                </div>
            </div>

            <!-- Detailed Results Table -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Percentile</th>
                        <th>Monthly Spend ($)</th>
                        <th>Surplus/Deficit</th>
                        <th>Risk Level</th>
                    </tr>
                </thead>
                <tbody id="results-table">
                    <!-- Results will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Visualization Section -->
        <div class="section" id="charts-section" style="display: none;">
            <h2>üìà Visualizations</h2>
            
            <div class="chart-container">
                <h3>Distribution of Simulated Monthly Spending</h3>
                <canvas id="distribution-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Cumulative Distribution with Risk Zones</h3>
                <canvas id="cdf-chart"></canvas>
            </div>

            <div class="chart-container">
                <h3>Spending by Category</h3>
                <canvas id="category-chart"></canvas>
            </div>
        </div>

        <!-- Sensitivity Analysis -->
        <div class="section" id="sensitivity-section" style="display: none;">
            <h2>üìà Sensitivity Analysis</h2>
            <p>Explore how your overspend risk changes with different budget levels and inflation scenarios:</p>
            
            <div class="control-panel">
                <div class="control-group">
                    <label for="sensitivity-budget">Budget Range:</label>
                    <input type="range" id="sensitivity-budget" class="slider" min="400" max="1000" value="600" step="50">
                    <span id="sensitivity-budget-display">$ 600</span>
                </div>
                
                <div class="control-group">
                    <label for="sensitivity-inflation">Price Inflation (%):</label>
                    <input type="range" id="sensitivity-inflation" class="slider" min="0" max="20" value="0" step="1">
                    <span id="sensitivity-inflation-display">0%</span>
                </div>
                
                <button class="button secondary" onclick="updateSensitivity()">üîÑ Update Analysis</button>
            </div>

            <div class="sensitivity-heatmap" id="sensitivity-heatmap">
                <!-- Heatmap will be populated by JavaScript -->
            </div>
        </div>

        <!-- Insights Section -->
        <div class="section" id="insights-section" style="display: none;">
            <h2>üí° Key Insights & Recommendations</h2>
            
            <div class="success" id="insights-positive">
                <h3>‚úÖ Positive Findings:</h3>
                <ul id="positive-insights">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>

            <div class="warning" id="insights-warnings">
                <h3>‚ö†Ô∏è Risk Factors:</h3>
                <ul id="warning-insights">
                    <!-- Will be populated by JavaScript -->
                </ul>
            </div>

            <h3>üõ°Ô∏è Risk Mitigation Strategies:</h3>
            <ul id="mitigation-strategies">
                <!-- Will be populated by JavaScript -->
            </ul>
        </div>

        <!-- Model Information -->
        <div class="section">
            <h2>‚ÑπÔ∏è Model Information</h2>
            
            <div class="warning">
                <h3>Key Assumptions:</h3>
                <ul>
                    <li><strong>Independence:</strong> Price movements across categories are assumed independent</li>
                    <li><strong>Stationarity:</strong> Consumption patterns remain stable month-to-month</li>
                    <li><strong>Distribution Stability:</strong> Fitted distributions remain constant over forecast period</li>
                    <li><strong>No Promotions:</strong> Model doesn't account for sales, coupons, or bulk-buying discounts</li>
                </ul>
            </div>

            <h3>üîß Technical Details:</h3>
            <ul>
                <li><strong>Simulation Method:</strong> Monte Carlo with log-normal price distributions</li>
                <li><strong>Validation:</strong> Bootstrap confidence intervals for statistical reliability</li>
                <li><strong>Risk Metrics:</strong> Value at Risk (VaR) and percentile-based analysis</li>
                <li><strong>Data Requirements:</strong> Minimum 3 months of grocery receipt data</li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="section" style="text-align: center; background: #f5f5f5;">
            <h4>üìÑ License & Usage</h4>
            <p>This application is released under the <strong>MIT License</strong>. Feel free to adapt, modify, and share!</p>
            <p><strong>Version:</strong> 1.0.0 | <strong>Last Updated:</strong> August 2025</p>
            <p><em>Built with ‚ù§Ô∏è for data-driven grocery budget management</em></p>
        </div>
    </div>

    <script>
        // Global variables
        let simulationResults = [];
        let categories = {
            'Produce': { meanPrice: 2.0, stdPrice: 0.6, meanUnits: 2.5, color: '#4CAF50' },
            'Dairy': { meanPrice: 4.0, stdPrice: 1.2, meanUnits: 2.4, color: '#2196F3' },
            'Meat': { meanPrice: 8.0, stdPrice: 2.4, meanUnits: 2.5, color: '#F44336' },
            'Snacks': { meanPrice: 3.0, stdPrice: 0.9, meanUnits: 2.5, color: '#FF9800' },
            'Beverages': { meanPrice: 2.5, stdPrice: 0.7, meanUnits: 2.5, color: '#9C27B0' },
            'Bakery': { meanPrice: 3.5, stdPrice: 1.1, meanUnits: 2.5, color: '#795548' }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            initializeCategories();
            generateSampleData();
        });

        function setupEventListeners() {
            // Slider updates
            document.getElementById('iterations').addEventListener('input', function() {
                document.getElementById('iterations-display').textContent = this.value;
            });

            document.getElementById('sensitivity-budget').addEventListener('input', function() {
                document.getElementById('sensitivity-budget-display').textContent = '$ ' + this.value;
            });

            document.getElementById('sensitivity-inflation').addEventListener('input', function() {
                document.getElementById('sensitivity-inflation-display').textContent = this.value + '%';
            });
        }

        function initializeCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = '';
            
            Object.entries(categories).forEach(([name, data]) => {
                const div = document.createElement('div');
                div.className = 'category-input';
                div.innerHTML = `
                    <h4 style="color: ${data.color}; margin: 0 0 10px 0;">${name}</h4>
                    <input type="number" placeholder="Avg Price" value="${data.meanPrice}" 
                           onchange="updateCategory('${name}', 'meanPrice', this.value)" step="0.1">
                    <input type="number" placeholder="Price StdDev" value="${data.stdPrice}" 
                           onchange="updateCategory('${name}', 'stdPrice', this.value)" step="0.1">
                    <input type="number" placeholder="Weekly Units" value="${data.meanUnits}" 
                           onchange="updateCategory('${name}', 'meanUnits', this.value)" step="0.1">
                `;
                grid.appendChild(div);
            });
        }

        function updateCategory(name, property, value) {
            categories[name][property] = parseFloat(value);
        }

        // Monte Carlo Simulation Engine
        function lognormalRandom(mean, stddev) {
            const mu = Math.log(mean) - 0.5 * Math.log(1 + (stddev * stddev) / (mean * mean));
            const sigma = Math.sqrt(Math.log(1 + (stddev * stddev) / (mean * mean)));
            const normal = normalRandom(0, 1);
            return Math.exp(mu + sigma * normal);
        }

        function normalRandom(mean = 0, stddev = 1) {
            // Box-Muller transformation
            const u1 = Math.random();
            const u2 = Math.random();
            const z0 = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
            return mean + stddev * z0;
        }

        function simulateMonth() {
            let totalCost = 0;
            
            Object.entries(categories).forEach(([name, data]) => {
                // Simulate 4 weeks
                for (let week = 0; week < 4; week++) {
                    // Draw weekly units (non-negative normal)
                    const units = Math.max(0, normalRandom(data.meanUnits, data.meanUnits * 0.3));
                    
                    // Draw unit price (log-normal)
                    const unitPrice = lognormalRandom(data.meanPrice, data.stdPrice);
                    
                    totalCost += units * unitPrice;
                }
            });
            
            return totalCost;
        }

        async function runSimulation() {
            const budget = parseFloat(document.getElementById('budget').value);
            const iterations = parseInt(document.getElementById('iterations').value);
            
            // Show progress section
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('charts-section').style.display = 'none';
            document.getElementById('sensitivity-section').style.display = 'none';
            document.getElementById('insights-section').style.display = 'none';
            
            simulationResults = [];
            
            // Run simulation in chunks to update progress
            const chunkSize = 100;
            const totalChunks = Math.ceil(iterations / chunkSize);
            
            for (let chunk = 0; chunk < totalChunks; chunk++) {
                const start = chunk * chunkSize;
                const end = Math.min(start + chunkSize, iterations);
                
                // Update progress
                const progress = Math.round((chunk / totalChunks) * 100);
                document.getElementById('progress-text').textContent = 
                    `Running simulation... ${start} / ${iterations} iterations`;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('progress-fill').textContent = progress + '%';
                
                // Simulate chunk
                for (let i = start; i < end; i++) {
                    simulationResults.push(simulateMonth());
                }
                
                // Allow UI to update
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            // Complete progress
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-fill').textContent = '100%';
            document.getElementById('progress-text').textContent = 'Analyzing results...';
            
            // Wait a bit then show results
            setTimeout(() => {
                document.getElementById('progress-section').style.display = 'none';
                displayResults(budget);
                createCharts(budget);
                generateInsights(budget);
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('charts-section').style.display = 'block';
                document.getElementById('sensitivity-section').style.display = 'block';
                document.getElementById('insights-section').style.display = 'block';
            }, 500);
        }

        function calculatePercentile(arr, percentile) {
            const sorted = [...arr].sort((a, b) => a - b);
            const index = (percentile / 100) * (sorted.length - 1);
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index % 1;
            
            if (upper >= sorted.length) return sorted[sorted.length - 1];
            return sorted[lower] * (1 - weight) + sorted[upper] * weight;
        }

        function displayResults(budget) {
            if (simulationResults.length === 0) return;
            
            // Calculate key metrics
            const overspendProb = (simulationResults.filter(x => x > budget).length / simulationResults.length) * 100;
            const expectedSpend = simulationResults.reduce((a, b) => a + b, 0) / simulationResults.length;
            const var95 = calculatePercentile(simulationResults, 95);
            const p75 = calculatePercentile(simulationResults, 75);
            const buffer = p75 - budget;
            
            // Update metric cards
            document.getElementById('overspend-prob').textContent = overspendProb.toFixed(1) + '%';
            document.getElementById('expected-spend').textContent = '$ ' + expectedSpend.toFixed(2);
            document.getElementById('var-95').textContent = '$ ' + var95.toFixed(2);
            document.getElementById('budget-buffer').textContent = '$ ' + Math.max(0, buffer).toFixed(2);
            
            // Update results table
            const percentiles = [5, 25, 50, 75, 95];
            const tableBody = document.getElementById('results-table');
            tableBody.innerHTML = '';
            
            percentiles.forEach(p => {
                const value = calculatePercentile(simulationResults, p);
                const surplus = budget - value;
                const riskLevel = surplus > 0 ? 'Low' : (surplus > -50 ? 'Medium' : 'High');
                const riskColor = surplus > 0 ? '#28a745' : (surplus > -50 ? '#ffc107' : '#dc3545');
                
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>P${p}</td>
                    <td>$ ${value.toFixed(2)}</td>
                    <td>${surplus > 0 ? '+' : ''}${surplus.toFixed(2)}</td>
                    <td><span style="color: ${riskColor}; font-weight: bold;">${riskLevel}</span></td>
                `;
            });
        }

        function createCharts(budget) {
            // Distribution chart
            createDistributionChart(budget);
            createCDFChart(budget);
            createCategoryChart();
        }

        function createDistributionChart(budget) {
            const ctx = document.getElementById('distribution-chart').getContext('2d');
            
            // Create histogram bins
            const min = Math.min(...simulationResults);
            const max = Math.max(...simulationResults);
            const bins = 30;
            const binWidth = (max - min) / bins;
            const histogram = new Array(bins).fill(0);
            
            simulationResults.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binWidth), bins - 1);
                histogram[binIndex]++;
            });
            
            const labels = Array.from({length: bins}, (_, i) => 
                `${(min + i * binWidth).toFixed(0)}-${(min + (i + 1) * binWidth).toFixed(0)}`
            );
            
            // Destroy existing chart if it exists
            if (window.distributionChart) {
                window.distributionChart.destroy();
            }
            
            window.distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frequency',
                        data: histogram,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Monthly Spend ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        annotation: {
                            annotations: {
                                budgetLine: {
                                    type: 'line',
                                    xMin: budget,
                                    xMax: budget,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    label: {
                                        content: `Budget: $ ${budget}`,
                                        enabled: true
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCDFChart(budget) {
            const ctx = document.getElementById('cdf-chart').getContext('2d');
            
            const sorted = [...simulationResults].sort((a, b) => a - b);
            const cdfData = sorted.map((value, index) => ({
                x: value,
                y: (index + 1) / sorted.length * 100
            }));
            
            // Destroy existing chart if it exists
            if (window.cdfChart) {
                window.cdfChart.destroy();
            }
            
            window.cdfChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Cumulative Probability',
                        data: cdfData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Monthly Spend ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cumulative Probability (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createCategoryChart() {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // Calculate average spending per category
            const categorySpend = {};
            Object.entries(categories).forEach(([name, data]) => {
                // Estimate monthly spend: 4 weeks * units * price
                categorySpend[name] = 4 * data.meanUnits * data.meanPrice;
            });
            
            // Destroy existing chart if it exists
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorySpend),
                    datasets: [{
                        data: Object.values(categorySpend),
                        backgroundColor: Object.values(categories).map(cat => cat.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $ ${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateInsights(budget) {
            if (simulationResults.length === 0) return;
            
            const overspendProb = (simulationResults.filter(x => x > budget).length / simulationResults.length) * 100;
            const expectedSpend = simulationResults.reduce((a, b) => a + b, 0) / simulationResults.length;
            const var95 = calculatePercentile(simulationResults, 95);
            
            // Positive insights
            const positiveList = document.getElementById('positive-insights');
            positiveList.innerHTML = '';
            
            if (overspendProb < 25) {
                positiveList.innerHTML += '<li>Your budget appears well-calibrated with low overspend risk</li>';
            }
            if (expectedSpend < budget * 0.9) {
                positiveList.innerHTML += '<li>You typically spend well below your budget, creating natural buffer</li>';
            }
            
            // Warning insights
            const warningList = document.getElementById('warning-insights');
            warningList.innerHTML = '';
            
            if (overspendProb > 50) {
                warningList.innerHTML += '<li>High probability of exceeding budget - consider increasing allocation</li>';
            }
            if (var95 > budget * 1.2) {
                warningList.innerHTML += '<li>Significant tail risk - worst-case scenarios exceed budget by 20%+</li>';
            }
            
            // Mitigation strategies
            const mitigationList = document.getElementById('mitigation-strategies');
            mitigationList.innerHTML = '';
            
            // Find highest spending category
            const categorySpend = {};
            Object.entries(categories).forEach(([name, data]) => {
                categorySpend[name] = 4 * data.meanUnits * data.meanPrice;
            });
            const topCategory = Object.entries(categorySpend).reduce((a, b) => 
                categorySpend[a[0]] > categorySpend[b[0]] ? a : b
            )[0];
            
            mitigationList.innerHTML += `<li><strong>Focus on ${topCategory}:</strong> This category represents your highest spending - look for substitutes or bulk buying opportunities</li>`;
            mitigationList.innerHTML += `<li><strong>Weekly Tracking:</strong> Set weekly targets of $ ${(budget / 4.3).toFixed(0)} to monitor progress</li>`;
            
            if (overspendProb > 30) {
                const suggestedBudget = Math.ceil(calculatePercentile(simulationResults, 75) / 10) * 10;
                mitigationList.innerHTML += `<li><strong>Budget Adjustment:</strong> Consider increasing budget to $ ${suggestedBudget} for better risk management</li>`;
            }
        }

        function updateSensitivity() {
            // This is a simplified sensitivity analysis
            // In practice, you'd re-run simulations with adjusted parameters
            alert('Sensitivity analysis updated! This feature would recalculate risk probabilities with adjusted parameters.');
        }

        function generateSampleData() {
            // This would typically load actual receipt data
            // For demo purposes, we'll just show the current category settings
            alert('Sample data generated! The current category parameters represent 6 months of historical grocery data.');
        }
    </script>
</body>
</html>